---
import { getCollection, type CollectionEntry } from "astro:content";
import { getAllVideos, getRelatedVideos, generateSlug } from "../../utils/videoUtils";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import type { GetStaticPaths } from "astro";

// Force prerender in SSR mode to avoid 500 errors
export const prerender = true;

export const getStaticPaths: GetStaticPaths = async () => {
  const videos = await getAllVideos();
  return videos.map((video) => ({
    params: { slug: video.slug },
    props: { video },
  }));
};

interface Props {
  video: CollectionEntry<"videos"> & {
    data: CollectionEntry<"videos">["data"] & {
      videoUrl: string;
      thumbnailUrl: string;
      previewUrl: string;
      videoSources: { src: string; type: string }[];
      videoFileName: string;
    };
  };
}

const { video }: Props = Astro.props;
const { Content } = await video.render();

// Get related videos
const relatedVideos = await getRelatedVideos(video.slug, video.data.category, 3);

// Build breadcrumb navigation
const breadcrumb = [
  { label: 'Home', href: '/' },
  { label: video.data.category, href: `/category/${generateSlug(video.data.category)}` },
  { label: video.data.title, href: '' }
];

// Format duration helper
function formatDuration(seconds: number | undefined): string {
  if (!seconds) return "N/A";
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Format taxonomy values for display
function formatTaxonomyValue(values: string[] | undefined): string {
  if (!values || values.length === 0) return "N/A";
  return values.map(v => v.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')).join(', ');
}
---

<Layout title={video.data.title}>
  <Header breadcrumb={breadcrumb} />

  <!-- Main Content: Video + Details Side by Side -->
  <main class="flex flex-col lg:flex-row w-full video-detail-main" id="video-main">
    <!-- Video Player Section (Left) -->
    <div class="video-player-container bg-black flex items-center justify-center relative" id="video-container">
      <video
        id="main-video"
        class="max-w-full max-h-full w-auto h-auto"
        autoplay
        muted
        loop
        playsinline
        style="object-fit: contain;"
      >
        <source src={video.data.videoUrl} type="video/mp4" />
        <source
          src={`/videos/${encodeURIComponent(video.data.videoFileName)}`}
          type="video/mp4"
        />
        Your browser does not support the video tag.
      </video>

      <!-- Play/Pause Overlay (shown on click) -->
      <div id="play-overlay" class="absolute inset-0 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200">
        <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-full p-8">
          <svg id="play-icon" class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg id="pause-icon" class="w-8 h-8 text-white hidden" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- Details Sidebar (Right) -->
    <div class="details-sidebar bg-white border-l border-gray-100 overflow-hidden" id="details-sidebar">
      <!-- Toggle Button (inside sidebar) -->
      <button
        id="sidebar-toggle-inside"
        class="sidebar-toggle-btn"
        title="Toggle sidebar"
      >
        <div class="toggle-icon">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </button>

      <!-- Collapsed State - Vertical Labels -->
      <div class="collapsed-labels" id="collapsed-labels">
        <div class="collapsed-content">
          <span class="vertical-text" data-section="project-details">Project Details</span>
          <span class="vertical-text" data-section="tags">TAGS</span>
          <span class="vertical-text" data-section="descriptions">DESCRIPTIONS</span>
        </div>
      </div>

      <!-- Expanded Content -->
      <div class="sidebar-content" id="sidebar-content">
        <div class="p-5 flex flex-col gap-5">
          <!-- Title & Author -->
          <div class="flex flex-col gap-4">
            <h1 class="text-[36px] leading-[48px] tracking-[-1.2px] text-gray-900">
              {video.data.title}
            </h1>
            <p class="text-[16px] leading-[24px] text-gray-400">
              by <a href={`/author/${generateSlug(video.data.author)}`} class="text-blue-600 hover:underline font-medium">{video.data.author}</a>
            </p>
            <p class="text-[16px] leading-[24px] text-gray-500 pt-4">
              {video.data.description}
            </p>
          </div>

          <!-- Project Details Section -->
          <div class="border-t border-gray-100 pt-12 flex flex-col gap-10">
            <!-- Project Details -->
            <div class="flex flex-col gap-4" id="project-details-section">
              <h3 class="text-[12px] tracking-[0.6px] uppercase text-gray-400 font-medium">Project Details</h3>
              <div class="flex flex-col gap-3" id="project-details-list">
                <!-- Year -->
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                  <span class="text-[14px] text-gray-500">Year</span>
                  <span class="text-[14px] text-black">{video.data.year || "N/A"}</span>
                </div>
                <!-- Duration -->
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                  <span class="text-[14px] text-gray-500">Duration</span>
                  <span class="text-[14px] text-black">{formatDuration(video.data.duration)}</span>
                </div>
                <!-- Category -->
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                  <span class="text-[14px] text-gray-500">Category</span>
                  <a href={`/category/${generateSlug(video.data.category)}`} class="text-[14px] text-blue-600 hover:underline">{video.data.category}</a>
                </div>
                <!-- Style -->
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                  <span class="text-[14px] text-gray-500">Style</span>
                  <span class="text-[14px] text-black">{formatTaxonomyValue(video.data.styles)}</span>
                </div>
                <!-- Technique -->
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                  <span class="text-[14px] text-gray-500">Technique</span>
                  <span class="text-[14px] text-black">{formatTaxonomyValue(video.data.techniques)}</span>
                </div>
                <!-- Sound/Music -->
                <div class="flex items-center justify-between py-2 border-b border-gray-50">
                  <span class="text-[14px] text-gray-500">Sound/Music</span>
                  <span class="text-[14px] text-black">{formatTaxonomyValue(video.data.soundMusic)}</span>
                </div>
                <!-- Link -->
                {video.data.sourceUrl && (
                  <div class="flex items-center justify-between py-2 border-b border-gray-50">
                    <span class="text-[14px] text-gray-500">Link</span>
                    <a href={video.data.sourceUrl} target="_blank" rel="noopener noreferrer" class="text-[14px] text-blue-600 hover:underline truncate max-w-[250px]">{video.data.sourceUrl}</a>
                  </div>
                )}
              </div>
            </div>

            <!-- Tags -->
            {video.data.tags && video.data.tags.length > 0 && (
              <div class="flex flex-col gap-4">
                <h3 class="text-[12px] tracking-[0.6px] uppercase text-gray-400 font-medium">Tags</h3>
                <div class="flex flex-wrap gap-2">
                  {video.data.tags.map((tag: string) => (
                    <a
                      href={`/tag/${generateSlug(tag)}`}
                      class="bg-gray-100 text-gray-600 px-3 py-1 rounded-sm text-[12px] font-medium hover:bg-gray-200 transition-colors"
                    >
                      {tag}
                    </a>
                  ))}
                </div>
              </div>
            )}

            <!-- Descriptions (Markdown Content) -->
            <div class="flex flex-col gap-4">
              <h3 class="text-[12px] tracking-[0.6px] uppercase text-gray-400 font-medium">Descriptions</h3>
              <div class="prose prose-sm max-w-none text-[16px] leading-[24px] text-gray-700">
                <Content />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Hover Overlays (shows on vertical label hover when sidebar collapsed) -->

  <!-- Project Details Overlay -->
  <div class="hover-details-overlay" id="hover-overlay-project-details" data-section="project-details">
    <div class="hover-details-card">
      <h3 class="text-[12px] tracking-[0.6px] uppercase text-gray-400 font-medium mb-3">Project Details</h3>
      <div class="flex flex-col gap-3">
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-[14px] text-gray-500">Year</span>
          <span class="text-[14px] text-black">{video.data.year || "N/A"}</span>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-[14px] text-gray-500">Duration</span>
          <span class="text-[14px] text-black">{formatDuration(video.data.duration)}</span>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-[14px] text-gray-500">Category</span>
          <span class="text-[14px] text-black">{video.data.category}</span>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-[14px] text-gray-500">Style</span>
          <span class="text-[14px] text-black">{formatTaxonomyValue(video.data.styles)}</span>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-[14px] text-gray-500">Technique</span>
          <span class="text-[14px] text-black">{formatTaxonomyValue(video.data.techniques)}</span>
        </div>
        <div class="flex items-center justify-between py-2 border-b border-gray-100">
          <span class="text-[14px] text-gray-500">Sound/Music</span>
          <span class="text-[14px] text-black">{formatTaxonomyValue(video.data.soundMusic)}</span>
        </div>
        {video.data.sourceUrl && (
          <div class="flex items-center justify-between py-2 border-b border-gray-100">
            <span class="text-[14px] text-gray-500">Link</span>
            <a href={video.data.sourceUrl} target="_blank" rel="noopener noreferrer" class="text-[14px] text-blue-600 hover:underline truncate max-w-[200px]">{video.data.sourceUrl.replace(/^https?:\/\//, '')}</a>
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- Tags Overlay -->
  <div class="hover-details-overlay" id="hover-overlay-tags" data-section="tags">
    <div class="hover-details-card">
      <h3 class="text-[12px] tracking-[0.6px] uppercase text-gray-400 font-medium mb-3">Tags</h3>
      {video.data.tags && video.data.tags.length > 0 ? (
        <div class="flex flex-wrap gap-2">
          {video.data.tags.map((tag: string) => (
            <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-sm text-[12px] font-medium">
              {tag}
            </span>
          ))}
        </div>
      ) : (
        <p class="text-[14px] text-gray-500">No tags available</p>
      )}
    </div>
  </div>

  <!-- Descriptions Overlay -->
  <div class="hover-details-overlay" id="hover-overlay-descriptions" data-section="descriptions">
    <div class="hover-details-card">
      <h3 class="text-[12px] tracking-[0.6px] uppercase text-gray-400 font-medium mb-3">Descriptions</h3>
      <div class="prose prose-sm max-w-none text-[14px] leading-[22px] text-gray-700">
        <Content />
      </div>
    </div>
  </div>

  <!-- Related Videos Section -->
  {relatedVideos.length > 0 && (
    <section class="w-full bg-white border-t border-white pt-10 pb-3 px-8">
      <p class="text-[10px] tracking-[1.5px] uppercase text-gray-500 font-medium text-center mb-3">Explore more</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
        {relatedVideos.map((relatedVideo) => (
          <a href={`/videos/${relatedVideo.slug}`} class="flex flex-col gap-1 group">
            <div class="aspect-video relative overflow-hidden bg-gray-100">
              <video
                class="related-video w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                muted
                loop
                playsinline
                preload="none"
                data-src={(relatedVideo.data as any).thumbnailUrl}
              >
                <source data-src={(relatedVideo.data as any).thumbnailUrl} type="video/mp4" />
              </video>
            </div>
            <div class="p-1">
              <p class="text-[14px] text-black">{relatedVideo.data.title}</p>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</Layout>

<style>
  /* Video detail layout */
  .video-detail-main {
    min-height: calc(100vh - 140px);
    position: relative;
  }

  /* Video player takes most of the width */
  .video-player-container {
    flex: 1;
    min-height: 400px;
    max-height: calc(100vh - 140px);
    position: relative;
  }

  /* Details sidebar - Three states: expanded, collapsed, hover */
  .details-sidebar {
    width: 100%;
    max-height: none;
    transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out;
    position: relative;
    display: flex;
  }

  /* Sidebar Toggle Button (inside sidebar) */
  .sidebar-toggle-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 22px;
    height: 22px;
    background: transparent;
    border: 1px solid #e5e7eb;
    border-radius: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    z-index: 20;
    color: #6b7280;
  }

  .sidebar-toggle-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
  }

  .sidebar-toggle-btn .toggle-icon {
    transition: transform 0.3s ease;
  }

  /* Collapsed Labels (vertical text) */
  .collapsed-labels {
    opacity: 0;
    pointer-events: none;
    width: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: opacity 0.3s ease, width 0.3s ease, padding 0.3s ease;
  }

  .collapsed-content {
    display: flex;
    flex-direction: column;
    gap: 40px;
    align-items: center;
    padding: 62px 0;
  }

  .vertical-text {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: #9ca3af;
    white-space: nowrap;
    cursor: pointer;
    transition: color 0.2s ease;
    padding: 8px 0;
  }

  .vertical-text:hover {
    color: #4b5563;
  }

  /* Sidebar Content */
  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    opacity: 1;
    transition: opacity 0.3s ease;
  }

  /* Hover Details Overlay */
  .hover-details-overlay {
    position: fixed;
    right: 100px;
    transform: translateX(20px);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s, top 0.3s ease;
    z-index: 9999;
  }

  .hover-details-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    width: 320px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    max-height: 80vh;
    overflow-y: auto;
  }

  /* Show hover overlay when hovering over vertical labels (only when sidebar is collapsed) */
  .hover-details-overlay.show {
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
    transform: translateX(0) !important;
  }

  @media (min-width: 1024px) {
    .video-player-container {
      min-height: calc(100vh - 140px);
    }

    .details-sidebar {
      width: 547px;
      min-width: 547px;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
    }

    /* Collapsed state - show vertical labels */
    .video-detail-main.sidebar-collapsed .details-sidebar {
      width: 63px;
      min-width: 63px;
    }

    .video-detail-main.sidebar-collapsed .sidebar-content {
      opacity: 0;
      pointer-events: none;
    }

    .video-detail-main.sidebar-collapsed .collapsed-labels {
      opacity: 1;
      pointer-events: auto;
      width: 63px;
      padding: 0 12px;
    }

    .video-detail-main.sidebar-collapsed .sidebar-toggle-btn {
      right: 13px;
    }

    .video-detail-main.sidebar-collapsed .sidebar-toggle-btn .toggle-icon {
      transform: rotate(180deg);
    }
  }

  @media (max-width: 1023px) {
    .video-detail-main {
      min-height: auto;
    }

    .video-player-container {
      height: 50vh;
      min-height: 300px;
      max-height: 60vh;
    }

    .sidebar-toggle-btn {
      display: none;
    }

    .hover-details-overlay {
      display: none;
    }
  }

  /* Related video lazy loading */
  .related-video {
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .related-video.loaded {
    opacity: 1;
  }

  /* Prose styling for markdown content */
  .prose p {
    margin-bottom: 1em;
  }

  .prose h1, .prose h2, .prose h3 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-weight: 500;
  }

  /* Scrollbar styling for sidebar */
  .details-sidebar::-webkit-scrollbar {
    width: 6px;
  }

  .details-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  .details-sidebar::-webkit-scrollbar-thumb {
    background: #e5e7eb;
    border-radius: 3px;
  }

  .details-sidebar::-webkit-scrollbar-thumb:hover {
    background: #d1d5db;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("main-video") as HTMLVideoElement;
    const playOverlay = document.getElementById("play-overlay");
    const playIcon = document.getElementById("play-icon");
    const pauseIcon = document.getElementById("pause-icon");

    // Sidebar toggle functionality
    const videoMain = document.getElementById("video-main");
    const sidebarToggleInside = document.getElementById("sidebar-toggle-inside");
    const videoContainer = document.getElementById("video-container");
    const hoverOverlay = document.getElementById("hover-overlay");

    // Load saved state from localStorage
    const sidebarState = localStorage.getItem('videoSidebarState') || 'open';

    if (sidebarState === 'collapsed' && videoMain) {
      videoMain.classList.add('sidebar-collapsed');
    }

    // Toggle sidebar on button click
    sidebarToggleInside?.addEventListener('click', () => {
      const isCollapsed = videoMain?.classList.contains('sidebar-collapsed');

      if (isCollapsed) {
        videoMain?.classList.remove('sidebar-collapsed');
        localStorage.setItem('videoSidebarState', 'open');
      } else {
        videoMain?.classList.add('sidebar-collapsed');
        localStorage.setItem('videoSidebarState', 'collapsed');
      }
    });

    // Hover overlay functionality for vertical labels (only when sidebar is collapsed)
    let hoverTimeout: NodeJS.Timeout | null = null;
    let currentOverlay: HTMLElement | null = null;

    // Get all vertical labels and overlays
    const verticalLabels = document.querySelectorAll('.vertical-text');
    const allOverlays = [
      document.getElementById('hover-overlay-project-details'),
      document.getElementById('hover-overlay-tags'),
      document.getElementById('hover-overlay-descriptions')
    ];

    // Function to hide all overlays
    function hideAllOverlays() {
      allOverlays.forEach(overlay => {
        overlay?.classList.remove('show');
      });
      currentOverlay = null;
    }

    // Function to show specific overlay
    function showOverlay(section: string, labelElement: Element) {
      if (!videoMain?.classList.contains('sidebar-collapsed')) return;

      hideAllOverlays();

      const overlay = document.getElementById(`hover-overlay-${section}`);
      if (overlay) {
        // Calculate position based on label element
        const labelRect = labelElement.getBoundingClientRect();
        const overlayCard = overlay.querySelector('.hover-details-card') as HTMLElement;

        if (overlayCard) {
          const overlayHeight = overlayCard.offsetHeight || 300; // fallback height
          // Position overlay to align with the label, but keep it within viewport
          let topPosition = labelRect.top + (labelRect.height / 2) - (overlayHeight / 2);

          // Ensure overlay doesn't go off screen
          const viewportHeight = window.innerHeight;
          const minTop = 20;
          const maxTop = viewportHeight - overlayHeight - 20;

          topPosition = Math.max(minTop, Math.min(topPosition, maxTop));

          overlay.style.top = `${topPosition}px`;
        }

        overlay.classList.add('show');
        currentOverlay = overlay;
      }
    }

    // Add hover listeners to vertical labels
    verticalLabels.forEach(label => {
      label.addEventListener('mouseenter', () => {
        if (videoMain?.classList.contains('sidebar-collapsed')) {
          if (hoverTimeout) {
            clearTimeout(hoverTimeout);
            hoverTimeout = null;
          }
          const section = label.getAttribute('data-section');
          if (section) {
            showOverlay(section, label);
          }
        }
      });

      label.addEventListener('mouseleave', () => {
        if (videoMain?.classList.contains('sidebar-collapsed')) {
          hoverTimeout = setTimeout(() => {
            if (!currentOverlay?.matches(':hover')) {
              hideAllOverlays();
            }
          }, 150);
        }
      });
    });

    // Keep overlay visible when hovering over it
    allOverlays.forEach(overlay => {
      overlay?.addEventListener('mouseenter', () => {
        if (videoMain?.classList.contains('sidebar-collapsed')) {
          if (hoverTimeout) {
            clearTimeout(hoverTimeout);
            hoverTimeout = null;
          }
        }
      });

      overlay?.addEventListener('mouseleave', () => {
        hoverTimeout = setTimeout(() => {
          hideAllOverlays();
        }, 150);
      });
    });

    if (video) {
      // Start muted for autoplay
      video.muted = true;
      video.volume = 0;

      // Unmute after user interaction
      let hasInteracted = false;

      function unmute() {
        if (!hasInteracted) {
          hasInteracted = true;
          video.muted = false;
          // Gradually increase volume
          let vol = 0;
          const fadeIn = setInterval(() => {
            if (vol < 0.25) {
              vol += 0.05;
              video.volume = Math.min(vol, 0.25);
            } else {
              clearInterval(fadeIn);
            }
          }, 200);
        }
      }

      // Click to play/pause
      video.addEventListener("click", (e) => {
        e.preventDefault();
        unmute();

        if (video.paused) {
          video.play();
          if (playIcon && pauseIcon) {
            playIcon.classList.add("hidden");
            pauseIcon.classList.remove("hidden");
          }
        } else {
          video.pause();
          if (playIcon && pauseIcon) {
            playIcon.classList.remove("hidden");
            pauseIcon.classList.add("hidden");
          }
        }

        // Flash the overlay
        if (playOverlay) {
          playOverlay.classList.remove("opacity-0", "pointer-events-none");
          setTimeout(() => {
            playOverlay.classList.add("opacity-0", "pointer-events-none");
          }, 300);
        }
      });

      // Update icons on play/pause events
      video.addEventListener("play", () => {
        if (playIcon && pauseIcon) {
          playIcon.classList.add("hidden");
          pauseIcon.classList.remove("hidden");
        }
      });

      video.addEventListener("pause", () => {
        if (playIcon && pauseIcon) {
          playIcon.classList.remove("hidden");
          pauseIcon.classList.add("hidden");
        }
      });
    }

    // Lazy load related videos
    const CONFIG = {
      rootMargin: '100px',
      threshold: 0.1,
      playThreshold: 0.3
    };

    let loadedVideos = new WeakSet<HTMLVideoElement>();

    const loadObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const video = entry.target as HTMLVideoElement;
          if (loadedVideos.has(video)) return;

          const dataSrc = video.getAttribute('data-src');
          if (dataSrc) {
            const source = video.querySelector('source');
            if (source) {
              source.src = dataSrc;
            }
            video.src = dataSrc;

            video.addEventListener('canplay', () => {
              loadedVideos.add(video);
              video.classList.add('loaded');
            }, { once: true });

            video.load();
          }
        }
      });
    }, {
      rootMargin: CONFIG.rootMargin,
      threshold: CONFIG.threshold
    });

    // Observe related videos
    const relatedVideoElements = document.querySelectorAll('.related-video');
    relatedVideoElements.forEach(video => {
      loadObserver.observe(video);
    });

    // Hover to play related videos
    const videoItems = document.querySelectorAll('section a.group');
    videoItems.forEach(item => {
      const video = item.querySelector('video') as HTMLVideoElement;
      if (video) {
        item.addEventListener('mouseenter', () => {
          if (loadedVideos.has(video)) {
            video.currentTime = 0;
            video.play().catch(() => {});
          }
        });
        item.addEventListener('mouseleave', () => {
          video.pause();
        });
      }
    });

    // Sidebar scroll isolation - when hovering sidebar, only scroll sidebar content
    const detailsSidebar = document.getElementById('details-sidebar');
    const sidebarContent = document.getElementById('sidebar-content');

    if (detailsSidebar && sidebarContent) {
      // When mouse enters sidebar, prevent page scroll and enable sidebar scroll
      detailsSidebar.addEventListener('mouseenter', () => {
        // Only apply when sidebar is expanded (not collapsed)
        if (!videoMain?.classList.contains('sidebar-collapsed')) {
          document.body.style.overflow = 'hidden';
        }
      });

      // When mouse leaves sidebar, restore page scroll
      detailsSidebar.addEventListener('mouseleave', () => {
        document.body.style.overflow = '';
      });

      // Handle wheel event on sidebar to scroll its content
      detailsSidebar.addEventListener('wheel', (e) => {
        // Only handle when sidebar is expanded
        if (videoMain?.classList.contains('sidebar-collapsed')) return;

        const scrollableContent = sidebarContent;
        const { scrollTop, scrollHeight, clientHeight } = scrollableContent;
        const deltaY = e.deltaY;

        // Check if we're at the top or bottom of the sidebar scroll
        const isAtTop = scrollTop === 0;
        const isAtBottom = scrollTop + clientHeight >= scrollHeight - 1;

        // Prevent page scroll when scrolling within sidebar bounds
        if ((deltaY < 0 && !isAtTop) || (deltaY > 0 && !isAtBottom)) {
          e.preventDefault();
          scrollableContent.scrollTop += deltaY;
        } else if ((deltaY < 0 && isAtTop) || (deltaY > 0 && isAtBottom)) {
          // Allow page scroll when at bounds - do nothing, let it propagate
        } else {
          e.preventDefault();
          scrollableContent.scrollTop += deltaY;
        }
      }, { passive: false });
    }
  });
</script>