---
import { getCollection, type CollectionEntry } from "astro:content";
import {
    getVideosByCategorySlug,
    getAllCategories,
    sortVideosByDate,
    generateSlug,
} from "../../../utils/videoUtils";
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/Header.astro";
import VideoGrid from "../../../components/VideoGrid.astro";
import type { GetStaticPaths } from "astro";

export const getStaticPaths: GetStaticPaths = async () => {
    const categories = await getAllCategories();
    const paths: Array<{
        params: { slug: string; page: string };
        props: { category: string; categorySlug: string; currentPage: number; totalPages: number };
    }> = [];
    
    for (const category of categories) {
        const categorySlug = generateSlug(category);
        const videos = sortVideosByDate(await getVideosByCategorySlug(categorySlug));
        const itemsPerPage = 24;
        const totalPages = Math.ceil(videos.length / itemsPerPage);
        
        for (let i = 1; i <= totalPages; i++) {
            paths.push({
                params: { slug: categorySlug, page: i.toString() },
                props: { category, categorySlug, currentPage: i, totalPages },
            });
        }
    }
    
    return paths;
};

interface Props {
    category: string;
    categorySlug: string;
    currentPage: number;
    totalPages: number;
}

const { category, categorySlug, currentPage, totalPages }: Props = Astro.props;
const pageNumber = parseInt(Astro.params.page as string || '1');

// Redirect to page 1 if invalid page number
if (pageNumber < 1 || pageNumber > totalPages) {
    return Astro.redirect(`/category/${categorySlug}`);
}

// Get videos for this category
const allVideos = await getVideosByCategorySlug(categorySlug);
const videos = sortVideosByDate(allVideos);
const itemsPerPage = 24;

// Calculate counts for header
const totalCount = videos.length;
const startIndex = (pageNumber - 1) * itemsPerPage;
const endIndex = Math.min(startIndex + itemsPerPage, totalCount);
const showingCount = endIndex - startIndex;

// Get all categories for breadcrumb/navigation
const allCategories = await getAllCategories();
---

<Layout title={`${category} Videos - Page ${pageNumber} - Showreel.design`}>
    <Header showingCount={showingCount} totalCount={totalCount} />
    <main>
        <!-- Hero Section -->
        <section class="py-20 bg-gray-900 text-white">
            <div class="section-container text-center">
                <!-- Breadcrumb -->
                <nav class="mb-8">
                    <ol
                        class="flex justify-center items-center space-x-2 text-sm text-gray-300"
                    >
                        <li>
                            <a
                                href="/"
                                class="hover:text-white transition-colors"
                                >Home</a>
                        </li>
                        <li class="text-gray-500">/</li>
                        <li><span class="text-gray-400">Category</span></li>
                        <li class="text-gray-500">/</li>
                        <li class="text-white font-medium">{category}</li>
                        <li class="text-gray-500">/</li>
                        <li class="text-gray-400">Page {pageNumber}</li>
                    </ol>
                </nav>

                <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
                    {category} Videos
                </h1>
                <p class="text-xl md:text-2xl text-gray-300 mb-8">
                    Discover amazing {category.toLowerCase()} projects and animations
                </p>
                <div class="text-lg text-gray-400">
                    {videos.length}
                    {videos.length === 1 ? "project" : "projects"} found
                    {totalPages > 1 && ` - Page ${pageNumber} of ${totalPages}`}
                </div>
            </div>
        </section>

        <!-- Use VideoGrid Component -->
        <VideoGrid
            videos={videos}
            currentCategory={category}
            showAllTab={true}
            currentPage={pageNumber}
            itemsPerPage={24}
            baseUrl={`/category/${categorySlug}`}
        />

        <!-- Empty State (only show if no videos in this category) -->
        {
            videos.length === 0 && (
                <section class="py-20 bg-gray-50">
                    <div class="section-container">
                        <div class="text-center py-16">
                            <div class="text-gray-400 text-6xl mb-4">ðŸŽ¬</div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">
                                No videos found
                            </h3>
                            <p class="text-gray-600 mb-8">
                                There are no videos in the {category} category
                                yet.
                            </p>
                            <a href="/" class="btn-primary">
                                Browse All Videos
                            </a>
                        </div>
                    </div>
                </section>
            )
        }
    </main>
</Layout>