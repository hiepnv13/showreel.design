---
import VideoCard from "./VideoCard.astro";
import Pagination from "./Pagination.astro";
import {
    getAllVideos,
    getAllCategories,
    sortVideosByDate,
    generateSlug,
} from "../utils/videoUtils";

// Props interface for reusability
interface Props {
    videos?: any[]; // Pre-filtered videos from parent page
    currentCategory?: string; // Current active category for highlighting tabs
    showAllTab?: boolean; // Whether to show "All Work" tab
    currentPage?: number; // Current page number
    itemsPerPage?: number; // Items per page
    baseUrl?: string; // Base URL for pagination
}

const {
    videos: propsVideos,
    currentCategory = "All",
    showAllTab = true,
    currentPage = 1,
    itemsPerPage = 24,
    baseUrl = "/",
} = Astro.props;

// If videos are passed as props, use them. Otherwise get all videos
const allVideos = propsVideos || sortVideosByDate(await getAllVideos());

// Calculate pagination
const totalVideos = allVideos.length;
const totalPages = Math.ceil(totalVideos / itemsPerPage);
const startIndex = (currentPage - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const displayVideos = allVideos.slice(startIndex, endIndex);

// Get all categories for filter tabs
const categories = await getAllCategories();

// Calculate video count for each category (using all videos for accurate counts)
const allVideosForCount = propsVideos ? await getAllVideos() : allVideos;
const categoryVideoCounts = categories.reduce(
    (counts, category) => {
        counts[category] = allVideosForCount.filter(
            (video) => video.data.category === category,
        ).length;
        return counts;
    },
    {} as Record<string, number>,
);

// Total video count for "All Work" tab
const totalVideoCount = allVideosForCount.length;
---

<main class="w-full bg-white video-grid px-8">
    <div class="grid grid-cols-3 gap-5">
        {
            displayVideos.map((video: any, index: number) => (
                <VideoCard
                    title={video.data.title}
                    author={video.data.author}
                    thumbnail={video.data.thumbnail}
                    videoUrl={video.data.thumbnailUrl}
                    fullVideoUrl={video.data.videoUrl}
                    category={video.data.category}
                    slug={video.slug}
                />
            ))
        }
    </div>

    <!-- Pagination -->
    <Pagination
        currentPage={currentPage}
        totalPages={totalPages}
        baseUrl={baseUrl}
    />
</main>

<script>
    // Import grid actions for interactive animations
    import "../scripts/gridActions.js";
</script>